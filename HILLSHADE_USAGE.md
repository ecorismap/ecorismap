# Hillshade (陰影起伏) 機能の使い方

EcorisMapでDEM（数値標高モデル）による陰影起伏表現が可能になりました。

## 使用方法

### 1. 地図タイルの追加

地図設定画面で、URLに`hillshade://`プレフィックスを付けてDEMタイルのURLを指定します：

#### GSI標準地図形式（対応形式）
```
hillshade://https://api.maptiler.com/tiles/terrain-rgb/{z}/{x}/{y}.png?key=YOUR_KEY
```

### 対応しているDEMタイル形式

- **GSI標準エンコーディング形式**
  - プレフィックス: `hillshade://`
  - RGB値から標高を計算: `elevation = R * 256 + G + B / 256 - 32768`
  - 例: MapTiler Terrain RGB
  - URL例: `hillshade://https://api.maptiler.com/tiles/terrain-rgb/{z}/{x}/{y}.png`

### 2. 表示設定

透明度スライダーで陰影の強さを調整できます。

### 3. 主な特徴

- **回転対応**: 地図の回転に応じて光源方向が自動調整（90度単位）
- **オーバーズーム対応**: 高ズームレベルでも鮮明な陰影表現
- **メモリ効率化**: LRUキャッシュによる最適化（最大50MB）
- **オフラインサポート**: DEMタイルもキャッシュされ、オフラインで使用可能

### 4. パラメータ（現在は固定値）

- **光源仰角**: 45度
- **ガンマ補正**: 1.0
- **高さ係数**: 100.0
- **回転量子化**: 90度単位（0°、90°、180°、270°）
- **ヒステリシス閾値**: 45度（不要な再描画を防止）

### 5. 技術仕様

- **アルゴリズム**: layer-hillshade.js互換
- **エッジ処理**: タイル境界での勾配外挿
- **NoDataハンドリング**: 標高データなしの領域は透明表示
- **キャッシュ**: 角度と座標をキーとしたLRUキャッシュ

### 6. 注意事項

- iOS/Android両プラットフォームで利用可能
- DEMタイルのダウンロードには時間がかかる場合があります
- 地形データのエンコーディング形式はGSI標準形式のみ対応

### 7. トラブルシューティング

- 陰影が表示されない場合:
  - URLが正しいか確認してください
  - APIキーが有効か確認してください
  - ネットワーク接続を確認してください
  
- パフォーマンスが悪い場合:
  - 透明度を下げてみてください
  - ズームレベルを調整してください

### 8. 今後の改善予定

- 光源パラメータのカスタマイズ機能
- 他のDEMエンコーディング形式への対応
- パフォーマンスの更なる最適化
- より細かい回転角度の量子化（現在は90度単位）